<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pulse: Native Edition</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050510;
            overflow: hidden; /* Chặn cuộn trang */
            touch-action: none; /* Chặn zoom trên mobile */
            font-family: 'Courier New', Courier, monospace;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* Để click xuyên qua UI xuống game */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        #score-board {
            font-size: 24px;
            text-shadow: 0 0 10px cyan;
        }
        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: auto;
            z-index: 100;
        }
        .btn {
            padding: 15px 40px;
            border: 2px solid cyan;
            color: cyan;
            background: transparent;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 15px cyan;
            font-family: inherit;
            margin-top: 20px;
        }
        .btn:active { background: cyan; color: black; }
        
        /* Mobile Controls */
        .control-zone {
            position: absolute;
            bottom: 50px;
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
            display: none; /* Ẩn trên PC */
        }
        #stick-zone { left: 40px; }
        #fire-zone { 
            right: 40px; 
            border-color: rgba(255, 0, 0, 0.4); 
            background: rgba(255, 0, 0, 0.1);
            display: none;
            justify-content: center;
            align-items: center;
        }
        #stick-nub {
            width: 50px; height: 50px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            position: relative;
            top: 35px; left: 35px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="score-board">SCORE: 0</div>
        <div id="stick-zone" class="control-zone"><div id="stick-nub"></div></div>
        <div id="fire-zone" class="control-zone" style="color:red; font-weight:bold;">FIRE</div>
    </div>

    <div id="start-screen">
        <h1 style="color: cyan; text-shadow: 0 0 20px cyan; font-size: 40px; text-align: center;">NEON DEFENDER</h1>
        <p>PC: WASD to Move, Click to Shoot</p>
        <p>Mobile: Left Joystick, Right Button</p>
        <button class="btn" onclick="startGame()">START GAME</button>
    </div>

<script>
/**
 * PURE JS ENGINE - NO LIBRARIES
 * Code by Gemini Senior Dev
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false }); // Tối ưu hiệu năng
const uiScore = document.getElementById('score-board');
const startScreen = document.getElementById('start-screen');
const stickZone = document.getElementById('stick-zone');
const stickNub = document.getElementById('stick-nub');
const fireZone = document.getElementById('fire-zone');

// --- Game State ---
let isPlaying = false;
let width, height;
let score = 0;
let lastTime = 0;
let spawnTimer = 0;

// Entities
const player = { x: 0, y: 0, r: 15, speed: 5, angle: 0, dead: false };
const bullets = [];
const enemies = [];
const particles = [];

// Input
const keys = {};
const mouse = { x: 0, y: 0, down: false };
const joystick = { active: false, dx: 0, dy: 0, originX: 0, originY: 0 };
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// --- Audio System (Synthesizer) ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx;

function playSound(type) {
    if (!actx) return;
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.connect(gain);
    gain.connect(actx.destination);

    const now = actx.currentTime;
    if (type === 'shoot') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    } else if (type === 'hit') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        osc.start(now);
        osc.stop(now + 0.2);
    } else if (type === 'over') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(10, now + 1);
        gain.gain.setValueAtTime(0.2, now);
        osc.start(now);
        osc.stop(now + 1);
    }
}

// --- Resize & Init ---
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    if (!isPlaying) {
        player.x = width / 2;
        player.y = height / 2;
    }
}
window.addEventListener('resize', resize);
resize();

if (isMobile) {
    stickZone.style.display = 'block';
    fireZone.style.display = 'flex';
}

// --- Input Handling ---
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);
window.addEventListener('mousemove', e => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
});
window.addEventListener('mousedown', () => {
    if (isPlaying && !isMobile) shoot();
});

// Mobile Touch Logic
stickZone.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.touches[0];
    joystick.active = true;
    joystick.originX = touch.clientX;
    joystick.originY = touch.clientY;
}, {passive: false});

stickZone.addEventListener('touchmove', e => {
    e.preventDefault();
    if (!joystick.active) return;
    const touch = e.touches[0];
    let dx = touch.clientX - joystick.originX;
    let dy = touch.clientY - joystick.originY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = 35;
    
    if (dist > maxDist) {
        dx = (dx / dist) * maxDist;
        dy = (dy / dist) * maxDist;
    }
    
    stickNub.style.transform = `translate(${dx}px, ${dy}px)`;
    joystick.dx = dx / maxDist;
    joystick.dy = dy / maxDist;
}, {passive: false});

const resetJoystick = () => {
    joystick.active = false;
    joystick.dx = 0; joystick.dy = 0;
    stickNub.style.transform = `translate(0px, 0px)`;
};
stickZone.addEventListener('touchend', resetJoystick);
fireZone.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

// --- Game Logic ---
function startGame() {
    startScreen.style.display = 'none';
    isPlaying = true;
    score = 0;
    bullets.length = 0;
    enemies.length = 0;
    particles.length = 0;
    player.dead = false;
    player.x = width/2;
    player.y = height/2;
    uiScore.innerText = "SCORE: 0";
    
    // Init Audio Context on user gesture
    actx = new AudioContext();
    actx.resume();

    requestAnimationFrame(loop);
}

function shoot() {
    if (player.dead) return;
    const angle = isMobile && (joystick.dx !== 0 || joystick.dy !== 0) 
        ? Math.atan2(joystick.dy, joystick.dx)
        : Math.atan2(mouse.y - player.y, mouse.x - player.x);
        
    bullets.push({
        x: player.x, y: player.y,
        vx: Math.cos(angle) * 15,
        vy: Math.sin(angle) * 15
    });
    playSound('shoot');
    
    // Recoil (Rung màn hình nhẹ)
    ctx.translate(Math.random() * 4 - 2, Math.random() * 4 - 2);
}

function spawnEnemy() {
    const r = 15;
    let x, y;
    if (Math.random() < 0.5) {
        x = Math.random() < 0.5 ? -r : width + r;
        y = Math.random() * height;
    } else {
        x = Math.random() * width;
        y = Math.random() < 0.5 ? -r : height + r;
    }
    enemies.push({ x, y, r, speed: 2 + Math.random() });
}

function createParticles(x, y, color) {
    for(let i=0; i<8; i++) {
        particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 1.0,
            color: color
        });
    }
}

function update(dt) {
    if (player.dead) return;

    // Player Move
    if (isMobile) {
        player.x += joystick.dx * player.speed;
        player.y += joystick.dy * player.speed;
    } else {
        if (keys['KeyW']) player.y -= player.speed;
        if (keys['KeyS']) player.y += player.speed;
        if (keys['KeyA']) player.x -= player.speed;
        if (keys['KeyD']) player.x += player.speed;
    }
    
    // Clamp Player
    player.x = Math.max(player.r, Math.min(width - player.r, player.x));
    player.y = Math.max(player.r, Math.min(height - player.r, player.y));

    // Bullets
    for (let i = bullets.length - 1; i >= 0; i--) {
        let b = bullets[i];
        b.x += b.vx;
        b.y += b.vy;
        if (b.x < 0 || b.x > width || b.y < 0 || b.y > height) bullets.splice(i, 1);
    }

    // Enemies
    spawnTimer++;
    if (spawnTimer > 60) { spawnEnemy(); spawnTimer = 0; }

    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        const angle = Math.atan2(player.y - e.y, player.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;

        // Collision Enemy vs Player
        const distP = Math.hypot(player.x - e.x, player.y - e.y);
        if (distP < player.r + e.r) {
            player.dead = true;
            playSound('over');
            setTimeout(() => {
                alert("GAME OVER! Score: " + score);
                startScreen.style.display = 'flex';
                isPlaying = false;
            }, 100);
        }

        // Collision Bullet vs Enemy
        for (let j = bullets.length - 1; j >= 0; j--) {
            let b = bullets[j];
            const distB = Math.hypot(b.x - e.x, b.y - e.y);
            if (distB < e.r + 5) { // 5 is bullet radius
                createParticles(e.x, e.y, '#ff0055');
                enemies.splice(i, 1);
                bullets.splice(j, 1);
                score += 10;
                uiScore.innerText = "SCORE: " + score;
                playSound('hit');
                break;
            }
        }
    }

    // Particles
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.05;
        if (p.life <= 0) particles.splice(i, 1);
    }
}

function draw() {
    // Clear & Background
    ctx.fillStyle = '#050510';
    ctx.fillRect(0, 0, width, height);

    // Draw Grid (Hiệu ứng)
    ctx.strokeStyle = '#001133';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let x=0; x<width; x+=50) { ctx.moveTo(x,0); ctx.lineTo(x,height); }
    for(let y=0; y<height; y+=50) { ctx.moveTo(0,y); ctx.lineTo(width,y); }
    ctx.stroke();

    if (player.dead) return;

    // Draw Player (Neon Triangle)
    ctx.save();
    ctx.translate(player.x, player.y);
    if (!isMobile) {
        const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
        ctx.rotate(angle);
    } else if (joystick.dx !== 0 || joystick.dy !== 0) {
        ctx.rotate(Math.atan2(joystick.dy, joystick.dx));
    }
    
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#00ffff';
    ctx.fillStyle = '#003333';
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(20, 0); ctx.lineTo(-15, 15); ctx.lineTo(-5, 0); ctx.lineTo(-15, -15);
    ctx.closePath();
    ctx.fill(); ctx.stroke();
    ctx.restore();

    // Draw Bullets
    ctx.shadowColor = '#ffff00';
    ctx.fillStyle = '#ffff00';
    bullets.forEach(b => {
        ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
    });

    // Draw Enemies
    ctx.shadowColor = '#ff0055';
    ctx.strokeStyle = '#ff0055';
    ctx.lineWidth = 2;
    enemies.forEach(e => {
        ctx.save();
        ctx.translate(e.x, e.y);
        ctx.rotate(Date.now() / 200); // Enemy spin
        ctx.strokeRect(-e.r, -e.r, e.r*2, e.r*2);
        
        // Mắt quái
        ctx.fillStyle = 'red';
        ctx.fillRect(-2, -2, 4, 4);
        ctx.restore();
    });

    // Draw Particles
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowColor = p.color;
        ctx.fillRect(p.x, p.y, 4, 4);
        ctx.globalAlpha = 1;
    });
}

function loop() {
    if (!isPlaying) return;
    update();
    draw();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
