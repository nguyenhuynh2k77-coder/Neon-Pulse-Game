<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pulse V6: Complete</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #050510;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between;
            padding: 15px; box-sizing: border-box;
        }
        
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .score-box { font-size: 20px; font-weight: bold; text-shadow: 0 0 10px cyan; }
        .wave-box { font-size: 24px; color: yellow; font-weight: bold; }
        
        /* HP Bar */
        .hp-wrapper { margin-top: 5px; }
        .hp-container {
            width: 200px; height: 15px;
            background: #333; border: 2px solid #555;
            position: relative;
        }
        #hp-bar {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff5500);
            transition: width 0.2s;
        }
        #hp-text {
            position: absolute; top: -2px; left: 0; width: 100%;
            text-align: center; font-size: 12px;
            text-shadow: 1px 1px 1px black;
        }

        /* Upgrade Modal */
        #upgrade-modal {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
            pointer-events: auto; z-index: 200;
        }
        #upgrade-modal h2 { color: cyan; text-shadow: 0 0 20px cyan; margin-bottom: 20px; }
        .cards-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .card {
            width: 120px; height: 160px;
            background: rgba(0, 40, 60, 0.9);
            border: 2px solid cyan; border-radius: 8px;
            padding: 10px; text-align: center;
            cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .card:active { transform: scale(0.95); background: cyan; color: black; }
        .card-icon { font-size: 35px; margin-bottom: 10px; }
        .card-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .card-desc { font-size: 11px; color: #ccc; }

        /* Start Screen with Skins */
        #start-screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto; z-index: 100;
        }
        .skin-container { display: flex; gap: 20px; margin: 20px 0; }
        .skin-btn {
            width: 80px; height: 80px;
            border: 2px solid #555; border-radius: 10px;
            cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.05);
        }
        .skin-btn.selected { border-color: white; box-shadow: 0 0 20px white; background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .skin-icon { font-size: 30px; margin-bottom: 5px; }
        .skin-name { font-size: 12px; font-weight: bold; }
        .skin-stats { font-size: 10px; color: #aaa; }

        .btn {
            padding: 15px 50px; margin-top: 30px;
            border: 2px solid cyan; color: cyan; background: transparent;
            font-size: 24px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 15px cyan;
        }
        
        #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
        }
        
        #notify {
            position: absolute; top: 20%; width: 100%;
            text-align: center; font-size: 40px; font-weight: bold;
            text-shadow: 0 0 20px white; display: none;
            animation: fadeUp 1.5s forwards;
        }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(20px); } 20% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* Mobile Controls */
        .control-zone {
            position: absolute; bottom: 30px;
            width: 120px; height: 120px;
            border-radius: 50%; pointer-events: auto; display: none;
            border: 2px solid rgba(255,255,255,0.1);
        }
        #stick-zone { left: 20px; }
        #fire-zone { right: 20px; background: rgba(255,0,0,0.1); display: none; }
        #stick-nub {
            width: 50px; height: 50px; background: rgba(0,255,255,0.5);
            border-radius: 50%; position: relative; top: 35px; left: 35px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div>
                <div class="score-box" id="score-text">SCORE: 0</div>
                <div class="hp-wrapper">
                    <div class="hp-container">
                        <div id="hp-bar"></div>
                        <div id="hp-text">100/100</div>
                    </div>
                </div>
            </div>
            <div class="wave-box" id="wave-text">WAVE 1</div>
        </div>
        <div id="notify"></div>

        <div id="stick-zone" class="control-zone"><div id="stick-nub"></div></div>
        <div id="fire-zone" class="control-zone"></div>
    </div>

    <div id="start-screen">
        <h1 style="color:cyan; text-shadow:0 0 20px cyan; font-size:40px; margin-bottom:10px;">NEON PULSE V6</h1>
        <p style="color:#ccc; margin-bottom:20px;">Select Your Ship Class</p>
        
        <div class="skin-container">
            <div class="skin-btn selected" onclick="selectSkin(0)">
                <div class="skin-icon" style="color:#00ffff">üöÄ</div>
                <div class="skin-name" style="color:#00ffff">CYAN</div>
                <div class="skin-stats">Balanced</div>
            </div>
            <div class="skin-btn" onclick="selectSkin(1)">
                <div class="skin-icon" style="color:#ff0055">üõ°Ô∏è</div>
                <div class="skin-name" style="color:#ff0055">RED</div>
                <div class="skin-stats">High DMG</div>
            </div>
            <div class="skin-btn" onclick="selectSkin(2)">
                <div class="skin-icon" style="color:#ffff00">‚ö°</div>
                <div class="skin-name" style="color:#ffff00">GOLD</div>
                <div class="skin-stats">Fast Fire</div>
            </div>
        </div>

        <button class="btn" onclick="startGame()">LAUNCH</button>
    </div>

    <div id="upgrade-modal">
        <h2>LEVEL UP!</h2>
        <div class="cards-container" id="cards-box"></div>
    </div>

    <div id="game-over-screen">
        <h1 style="color:red; text-shadow:0 0 20px red;">MISSION FAILED</h1>
        <p id="final-score" style="color:white; font-size:24px;">Score: 0</p>
        <button class="btn" onclick="document.getElementById('game-over-screen').style.display='none'; document.getElementById('start-screen').style.display='flex';">MAIN MENU</button>
    </div>

<script>
// --- CONFIG & GLOBALS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let width, height;

// Stats
let isPlaying = false, isPaused = false;
let score = 0, wave = 1, frameCount = 0;
let enemiesToSpawn = 0, waveState = 'waiting', spawnTimer = 0;

// --- SKIN SYSTEM ---
let currentSkinIndex = 0;
const skins = [
    { name: 'Cyan', color: '#00ffff', body: '#003333', dmg: 1, fireRate: 20, desc: 'Standard' },
    { name: 'Red',  color: '#ff0055', body: '#330011', dmg: 2, fireRate: 30, desc: 'Heavy Hit' }, // B·∫Øn ch·∫≠m, dame to
    { name: 'Gold', color: '#ffff00', body: '#333300', dmg: 1, fireRate: 15, desc: 'Rapid Fire' } // B·∫Øn nhanh, dame nh·ªè
];

function selectSkin(idx) {
    currentSkinIndex = idx;
    document.querySelectorAll('.skin-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i === idx);
    });
}

// --- PLAYER ---
const player = {
    x: 0, y: 0, r: 15,
    hp: 100, maxHp: 100,
    dead: false,
    damage: 1,
    fireRate: 20,
    lastShot: 0,
    shotCount: 1,
    rearShot: false,
    invulnTimer: 0
};

// --- ENTITIES ---
let bullets = [], enemyBullets = [], enemies = [], particles = [], drops = [], floatingTexts = [];

// --- UPGRADES ---
const upgradePool = [
    { id: 'multishot', name: 'ƒê·∫°n K√©p', icon: 'üî´', desc: '+1 Tia ƒê·∫°n' },
    { id: 'damage',    name: 'S√°t Th∆∞∆°ng', icon: 'üí•', desc: '+1 Damage' },
    { id: 'firerate',  name: 'T·ªëc B·∫Øn', icon: '‚ö°', desc: 'B·∫Øn nhanh h∆°n' }, // ƒê√£ nerf
    { id: 'maxhp',     name: 'M√°u Tr√¢u', icon: '‚ù§Ô∏è', desc: '+20 Max HP' },
    { id: 'rearshot',  name: 'B·∫Øn L∆∞ng', icon: 'üîô', desc: 'B·∫Øn ph√≠a sau' },
    { id: 'heal',      name: 'H·ªìi Ph·ª•c', icon: 'ü©π', desc: 'H·ªìi 50 HP' }
];

// --- AUDIO ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx;
function playSound(type) {
    if (!actx) return;
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.connect(gain); gain.connect(actx.destination);
    const now = actx.currentTime;

    if (type === 'shoot') {
        osc.frequency.setValueAtTime(skins[currentSkinIndex].color==='#ff0055'?150:400, now); // Red sounds lower
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'hit') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'levelup') {
        osc.type = 'square'; osc.frequency.setValueAtTime(200, now);
        osc.frequency.linearRampToValueAtTime(600, now + 0.4);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
        osc.start(now); osc.stop(now + 0.4);
    }
}

// --- INIT ---
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    if(!isPlaying) { player.x = width/2; player.y = height/2; }
}
window.addEventListener('resize', resize);
resize();
if (isMobile) {
    document.getElementById('stick-zone').style.display = 'block';
    document.getElementById('fire-zone').style.display = 'block';
}

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-over-screen').style.display = 'none';
    
    // Init Stats based on Skin
    const s = skins[currentSkinIndex];
    isPlaying = true; isPaused = false; score = 0; wave = 1;
    player.hp = 100; player.maxHp = 100; player.dead = false;
    player.damage = s.dmg; 
    player.fireRate = s.fireRate; 
    player.shotCount = 1; player.rearShot = false;
    player.x = width/2; player.y = height/2;
    
    bullets = []; enemies = []; enemyBullets = []; particles = []; drops = []; floatingTexts = [];
    
    updateUI();
    actx = new AudioContext(); actx.resume();
    startWave();
    requestAnimationFrame(loop);
}

function startWave() {
    waveState = 'spawning';
    document.getElementById('wave-text').innerText = "WAVE " + wave;
    showNotify("WAVE " + wave);
    
    if (wave % 10 === 0) { enemiesToSpawn = 1; spawnBoss('mega'); }
    else if (wave % 5 === 0) { enemiesToSpawn = 1; spawnBoss('mini'); }
    else { enemiesToSpawn = 5 + wave; }
}

function spawnBoss(type) {
    waveState = 'boss';
    let hp = (type==='mega') ? 800 + wave*50 : 300 + wave*30;
    enemies.push({ 
        x: width/2, y: -100, r: type==='mega'?70:40, 
        hp: hp, maxHp: hp, type: 'boss_'+type, 
        color: type==='mega'?'#ff0000':'#ffaa00', 
        speed: type==='mega'?1:2, angle: 0, reload: 0 
    });
    showNotify(type==='mega' ? "MEGA BOSS" : "MINI BOSS");
}

function spawnNormal() {
    if (enemiesToSpawn <= 0) { waveState = 'fighting'; return; }
    let type='chaser', hp=2+Math.floor(wave/4), spd=2+Math.random(), r=15, col='#ff0055';
    if(wave>=2 && Math.random()>0.7) { type='shooter'; col='#00ff00'; spd=1.5; hp=3; }
    if(wave>=4 && Math.random()>0.9) { type='tank'; r=25; hp=10; col='#5555ff'; spd=1; }
    
    let ex=Math.random()*width, ey=Math.random()*height;
    if(Math.random()<0.5) ex=(ex<width/2)?-50:width+50; else ey=(ey<height/2)?-50:height+50;
    
    enemies.push({ x: ex, y: ey, r, hp, maxHp: hp, type, color: col, speed: spd, angle: 0, reload: 0 });
    enemiesToSpawn--;
}

// --- UPGRADE SYSTEM ---
function triggerUpgrade() {
    isPaused = true; playSound('levelup');
    const modal = document.getElementById('upgrade-modal');
    const box = document.getElementById('cards-box');
    modal.style.display = 'flex'; box.innerHTML = '';

    let choices = [];
    while(choices.length < 3) {
        let item = upgradePool[Math.floor(Math.random() * upgradePool.length)];
        if(!choices.includes(item)) choices.push(item);
    }

    choices.forEach(item => {
        let card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="card-icon">${item.icon}</div><div class="card-title">${item.name}</div><div class="card-desc">${item.desc}</div>`;
        card.onclick = () => applyUpgrade(item.id);
        box.appendChild(card);
    });
}

function applyUpgrade(id) {
    if(id==='multishot') player.shotCount++;
    if(id==='damage') player.damage++;
    // FIX T·ªêC ƒê·ªò B·∫ÆN: Gi·ªõi h·∫°n t·ªëi ƒëa l√† 10 (kh√¥ng th·∫•p h∆°n 10)
    if(id==='firerate') player.fireRate = Math.max(10, player.fireRate - 2); 
    if(id==='maxhp') { player.maxHp+=20; player.hp=player.maxHp; }
    if(id==='rearshot') player.rearShot = true;
    if(id==='heal') player.hp = Math.min(player.maxHp, player.hp+50);

    updateUI();
    document.getElementById('upgrade-modal').style.display = 'none';
    isPaused = false;
    requestAnimationFrame(loop);
}

// --- INPUT ---
const keys={}; const mouse={x:0,y:0,down:false}; const joy={active:false,dx:0,dy:0,sx:0,sy:0};
window.onkeydown=e=>keys[e.code]=true; window.onkeyup=e=>keys[e.code]=false;
window.onmousemove=e=>{mouse.x=e.clientX;mouse.y=e.clientY;};
window.onmousedown=()=>mouse.down=true; window.onmouseup=()=>mouse.down=false;

const stick=document.getElementById('stick-zone'); const nub=document.getElementById('stick-nub');
stick.ontouchstart=e=>{e.preventDefault();joy.active=true;joy.sx=e.touches[0].clientX;joy.sy=e.touches[0].clientY;};
stick.ontouchmove=e=>{
    e.preventDefault(); if(!joy.active)return;
    let dx=e.touches[0].clientX-joy.sx, dy=e.touches[0].clientY-joy.sy;
    let dist=Math.min(Math.hypot(dx,dy),35); let ang=Math.atan2(dy,dx);
    joy.dx=Math.cos(ang); joy.dy=Math.sin(ang);
    nub.style.transform=`translate(${joy.dx*dist}px, ${joy.dy*dist}px)`;
};
stick.ontouchend=()=>{joy.active=false;joy.dx=0;joy.dy=0;nub.style.transform=`translate(0,0)`;};
document.getElementById('fire-zone').ontouchstart=e=>{e.preventDefault();mouse.down=true;};
document.getElementById('fire-zone').ontouchend=e=>{e.preventDefault();mouse.down=false;};

// --- GAME LOOP ---
function update() {
    if(isPaused || player.dead) return;

    if(waveState==='spawning') { spawnTimer++; if(spawnTimer>40){ spawnNormal(); spawnTimer=0; }}
    else if((waveState==='fighting'||waveState==='boss') && enemies.length===0 && enemiesToSpawn===0) {
        wave++; setTimeout(startWave, 2000); waveState='waiting';
    }

    // Move
    if(isMobile) { player.x+=joy.dx*5; player.y+=joy.dy*5; if(mouse.down) fire(); }
    else {
        if(keys['KeyW'])player.y-=5; if(keys['KeyS'])player.y+=5;
        if(keys['KeyA'])player.x-=5; if(keys['KeyD'])player.x+=5;
        if(mouse.down||keys['Space']) fire();
    }
    player.x=Math.max(15, Math.min(width-15, player.x));
    player.y=Math.max(15, Math.min(height-15, player.y));
    if(player.invulnTimer>0) player.invulnTimer--;

    // Bullets
    bullets.forEach(b=>{b.x+=b.vx; b.y+=b.vy;});
    bullets=bullets.filter(b=>b.x>0&&b.x<width&&b.y>0&&b.y<height);
    
    enemyBullets.forEach(b=>{
        b.x+=b.vx; b.y+=b.vy;
        if(Math.hypot(b.x-player.x, b.y-player.y)<player.r) takeDamage(10);
    });
    enemyBullets=enemyBullets.filter(b=>b.x>0&&b.x<width&&b.y>0&&b.y<height);

    // Enemies
    for(let i=enemies.length-1; i>=0; i--){
        let e=enemies[i], ang=Math.atan2(player.y-e.y, player.x-e.x);
        
        // AI
        if(e.type.includes('boss')) {
            e.y = Math.min(100, e.y+e.speed); e.reload++;
            if(e.type==='boss_mega' && e.reload>10) {
                e.angle+=0.1;
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle)*4, vy:Math.sin(e.angle)*4});
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle+Math.PI)*4, vy:Math.sin(e.angle+Math.PI)*4});
                e.reload=0;
            } else if (e.type==='boss_mini' && e.reload>60) {
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*6, vy:Math.sin(ang)*6});
                e.reload=0;
            }
        } else {
            if(e.type!=='shooter' || Math.hypot(player.x-e.x, player.y-e.y)>250) { e.x+=Math.cos(ang)*e.speed; e.y+=Math.sin(ang)*e.speed; }
            if(e.type==='shooter') { e.reload++; if(e.reload>100){ enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5}); e.reload=0; }}
        }

        // Bullet Hit
        for(let j=bullets.length-1; j>=0; j--){
            if(Math.hypot(bullets[j].x-e.x, bullets[j].y-e.y) < e.r+5) {
                bullets.splice(j,1); e.hp-=player.damage; e.x+=(Math.random()-0.5)*4;
                if(e.hp<=0) {
                    enemies.splice(i,1); score+=(e.type.includes('boss')?500:10); playSound('hit');
                    spawnDrop(e.x,e.y);
                }
                break;
            }
        }
        if(enemies[i] && Math.hypot(player.x-enemies[i].x, player.y-enemies[i].y)<player.r+enemies[i].r) takeDamage(20);
    }

    // Drops
    for(let i=drops.length-1; i>=0; i--){
        let d=drops[i]; d.y+=Math.sin(frameCount/10)*0.5; d.life--;
        if(Math.hypot(player.x-d.x, player.y-d.y)<player.r+d.r) {
            if(d.type==='upgrade') triggerUpgrade();
            else if(d.type==='heal') { player.hp=Math.min(player.maxHp, player.hp+30); addText(player.x,player.y,"+30 HP","#0f0"); }
            else if(d.type==='speed') { 
                // NERFED YELLOW ORB
                player.fireRate=Math.max(10, player.fireRate-1); 
                addText(player.x,player.y,"FIRE UP","yellow"); 
            }
            else { score+=100; addText(player.x,player.y,"+100","white"); }
            drops.splice(i,1);
        } else if(d.life<=0) drops.splice(i,1);
    }
    updateUI();
}

function fire() {
    if(frameCount-(player.lastShot||0) < player.fireRate) return;
    player.lastShot=frameCount; playSound('shoot');
    const ang = (isMobile && (joy.dx||joy.dy)) ? Math.atan2(joy.dy, joy.dx) : Math.atan2(mouse.y-player.y, mouse.x-player.x);
    
    let startAng = ang - (player.shotCount-1)*0.1;
    for(let i=0; i<player.shotCount; i++) {
        let a = startAng + i*0.2;
        bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*15, vy:Math.sin(a)*15});
    }
    if(player.rearShot) bullets.push({x:player.x, y:player.y, vx:Math.cos(ang+Math.PI)*15, vy:Math.sin(ang+Math.PI)*15});
}

function takeDamage(n) {
    if(player.invulnTimer>0) return;
    player.hp-=n; player.invulnTimer=60; addText(player.x,player.y-30,"-"+n,"red");
    if(player.hp<=0) { player.hp=0; isPlaying=false; document.getElementById('game-over-screen').style.display='flex'; document.getElementById('final-score').innerText="Score: "+score; }
}

function spawnDrop(x,y) {
    if(Math.random()>0.3) return;
    let r=Math.random(), t='score', c='white';
    if(r<0.1){t='heal';c='red';} else if(r<0.2){t='upgrade';c='cyan';} else if(r<0.3){t='speed';c='yellow';}
    drops.push({x,y,type:t,color:c,r:10,life:600});
}

function addText(x,y,t,c){ floatingTexts.push({x,y,t,c,life:50}); }
function showNotify(t){ const n=document.getElementById('notify'); n.innerText=t; n.style.display='none'; void n.offsetWidth; n.style.display='block'; }
function updateUI(){
    document.getElementById('score-text').innerText="SCORE: "+score;
    document.getElementById('hp-bar').style.width=(player.hp/player.maxHp*100)+"%";
    document.getElementById('hp-text').innerText=Math.floor(player.hp)+"/"+player.maxHp;
}

function draw() {
    ctx.fillStyle='#050510'; ctx.fillRect(0,0,width,height);
    ctx.strokeStyle='#001133'; ctx.lineWidth=1; ctx.beginPath();
    for(let x=0;x<width;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,height);}
    for(let y=0;y<height;y+=50){ctx.moveTo(0,y);ctx.lineTo(width,y);} ctx.stroke();

    drops.forEach(d=>{
        ctx.fillStyle=d.color; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='black'; ctx.font='10px Arial'; ctx.textAlign='center';
        ctx.fillText(d.type==='upgrade'?'‚ö°':(d.type==='heal'?'‚ù§':(d.type==='speed'?'‚è©':'?')), d.x,d.y+3);
    });

    if(!player.dead && player.invulnTimer%4<2) {
        ctx.save(); ctx.translate(player.x, player.y);
        let rot = (isMobile && (joy.dx||joy.dy)) ? Math.atan2(joy.dy, joy.dx) : Math.atan2(mouse.y-player.y, mouse.x-player.x);
        ctx.rotate(rot);
        const s = skins[currentSkinIndex];
        ctx.fillStyle=s.body; ctx.strokeStyle=s.color; ctx.lineWidth=2;
        ctx.shadowBlur=10; ctx.shadowColor=s.color;
        ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,15); ctx.lineTo(-5,0); ctx.lineTo(-15,-15); ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.restore();
    }

    ctx.fillStyle='#ffff00'; bullets.forEach(b=>{ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill();});
    ctx.fillStyle='#fff'; enemyBullets.forEach(b=>{ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill();});

    enemies.forEach(e=>{
        ctx.save(); ctx.translate(e.x,e.y);
        ctx.strokeStyle=e.color; ctx.lineWidth=2; ctx.shadowColor=e.color;
        if(e.type.includes('boss')){
            ctx.rotate(e.angle); ctx.beginPath(); ctx.arc(0,0,e.r,0,Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-e.r,0); ctx.lineTo(e.r,0); ctx.moveTo(0,-e.r); ctx.lineTo(0,e.r); ctx.stroke();
        } else {
            if(e.type==='tank') ctx.strokeRect(-e.r,-e.r,e.r*2,e.r*2);
            else { ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.closePath(); ctx.stroke(); }
        }
        ctx.restore();
        if(e.hp<e.maxHp){
            let bw=e.r*2; ctx.fillStyle='red'; ctx.fillRect(e.x-bw/2, e.y-e.r-8, bw, 3);
            ctx.fillStyle='#0f0'; ctx.fillRect(e.x-bw/2, e.y-e.r-8, bw*(e.hp/e.maxHp), 3);
        }
    });

    floatingTexts.forEach(t=>{ t.y-=1; t.life--; ctx.fillStyle=t.c; ctx.font='bold 16px Arial'; ctx.fillText(t.t,t.x,t.y); });
    floatingTexts=floatingTexts.filter(t=>t.life>0);
}

function loop() { if(!isPaused){frameCount++;update();} if(isPlaying){draw();requestAnimationFrame(loop);} }
</script>
</body>
</html>
