<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pulse: Boss Fixed</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #050510;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }
        #score-board {
            font-size: 24px; font-weight: bold;
            text-shadow: 0 0 10px cyan;
        }
        #debug-info {
            font-size: 14px; color: #888; margin-top: 5px;
        }
        
        #start-screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            pointer-events: auto; z-index: 100;
        }
        h1 { margin-bottom: 10px; color: cyan; text-shadow: 0 0 20px cyan; text-align: center; }
        .skin-container { display: flex; gap: 15px; margin: 20px 0; }
        .skin-btn {
            width: 60px; height: 60px;
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center; font-size: 24px;
        }
        .skin-btn.selected { border-color: white; box-shadow: 0 0 15px white; transform: scale(1.1); }
        .btn-start {
            padding: 15px 50px;
            border: 2px solid cyan; color: cyan; background: transparent;
            font-size: 24px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 0 15px cyan; font-weight: bold;
        }
        .btn-start:active { background: cyan; color: black; }

        /* Mobile Controls */
        .control-zone {
            position: absolute; bottom: 50px;
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto; display: none;
        }
        #stick-zone { left: 30px; }
        #fire-zone { right: 30px; background: rgba(255, 0, 0, 0.1); display: none; }
        #stick-nub {
            width: 50px; height: 50px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            position: relative; top: 35px; left: 35px;
            pointer-events: none;
        }
        
        /* Boss Warning */
        #boss-warning {
            position: absolute; top: 40%; width: 100%;
            text-align: center; color: red; font-size: 40px; font-weight: bold;
            display: none; text-shadow: 0 0 20px red;
            background: rgba(0,0,0,0.5); padding: 20px 0;
            animation: blink 0.5s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div>
            <div id="score-board">SCORE: 0</div>
            <div id="debug-info">Boss at 50 pts (or press 'B')</div>
        </div>
        <div id="boss-warning">‚ö†Ô∏è WARNING: BOSS APPROACHING ‚ö†Ô∏è</div>
        
        <div id="stick-zone" class="control-zone"><div id="stick-nub"></div></div>
        <div id="fire-zone" class="control-zone"></div>
    </div>

    <div id="start-screen">
        <h1>NEON DEFENDER V3.1</h1>
        <p>CHOOSE YOUR SHIP</p>
        <div class="skin-container">
            <div class="skin-btn selected" onclick="selectSkin(0)" style="background: #003333; border-color: #00ffff;">üöÄ</div>
            <div class="skin-btn" onclick="selectSkin(1)" style="background: #330000; border-color: #ff0000;">üõ°Ô∏è</div>
            <div class="skin-btn" onclick="selectSkin(2)" style="background: #333300; border-color: #ffff00;">‚ö°</div>
        </div>
        <button class="btn-start" onclick="startGame()">START GAME</button>
    </div>

<script>
// --- CORE SETUP ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const uiScore = document.getElementById('score-board');
const startScreen = document.getElementById('start-screen');
const warningText = document.getElementById('boss-warning');
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

let width, height;
let isPlaying = false;
let score = 0;
let frameCount = 0;
let bossActive = false;

// --- AUDIO ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx;
function playSound(type) {
    if (!actx) return;
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.connect(gain);
    gain.connect(actx.destination);
    const now = actx.currentTime;

    if (type === 'shoot') {
        osc.frequency.setValueAtTime(skins[currentSkin].shootPitch, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'boss_alarm') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(800, now + 0.5);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 1);
        osc.start(now); osc.stop(now + 1);
    }
}

// --- SKINS ---
let currentSkin = 0;
const skins = [
    { name: "Cyan", color: '#00ffff', body: '#003333', bullet: '#00ffff', shootPitch: 400, speed: 5 },
    { name: "Red",  color: '#ff0055', body: '#330011', bullet: '#ff0055', shootPitch: 150, speed: 4 },
    { name: "Gold", color: '#ffff00', body: '#333300', bullet: '#ffff00', shootPitch: 800, speed: 7 }
];

function selectSkin(index) {
    currentSkin = index;
    document.querySelectorAll('.skin-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i === index);
    });
}

// --- GAME OBJECTS ---
const player = { x: 0, y: 0, r: 15, dead: false, hp: 100 };
let bullets = [];
let enemyBullets = [];
let enemies = [];
let particles = [];

// --- RESIZE ---
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    if(!isPlaying) { player.x = width/2; player.y = height/2; }
}
window.addEventListener('resize', resize);
resize();

if (isMobile) {
    document.getElementById('stick-zone').style.display = 'block';
    document.getElementById('fire-zone').style.display = 'block';
}

function startGame() {
    startScreen.style.display = 'none';
    isPlaying = true;
    score = 0;
    bossActive = false;
    bullets = []; enemies = []; enemyBullets = []; particles = [];
    player.dead = false;
    player.x = width/2; player.y = height/2;
    uiScore.innerText = "SCORE: 0";
    
    actx = new AudioContext();
    actx.resume();
    requestAnimationFrame(loop);
}

// --- CONTROLS ---
const keys = {};
const mouse = { x: 0, y: 0 };
const joystick = { active: false, dx: 0, dy: 0, startX: 0, startY: 0 };

window.addEventListener('keydown', e => {
    keys[e.code] = true;
    // CHEAT CODE: Press B to Spawn Boss
    if (e.code === 'KeyB' && isPlaying) summonBoss();
});
window.addEventListener('keyup', e => keys[e.code] = false);
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mousedown', () => { if(isPlaying && !isMobile) shoot(); });

// Mobile Joy
const stickZone = document.getElementById('stick-zone');
const stickNub = document.getElementById('stick-nub');
stickZone.addEventListener('touchstart', e => {
    e.preventDefault();
    joystick.active = true;
    joystick.startX = e.touches[0].clientX;
    joystick.startY = e.touches[0].clientY;
}, {passive:false});
stickZone.addEventListener('touchmove', e => {
    e.preventDefault();
    if(!joystick.active) return;
    let dx = e.touches[0].clientX - joystick.startX;
    let dy = e.touches[0].clientY - joystick.startY;
    const dist = Math.min(Math.hypot(dx, dy), 35);
    const angle = Math.atan2(dy, dx);
    joystick.dx = Math.cos(angle); joystick.dy = Math.sin(angle);
    stickNub.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
}, {passive:false});
stickZone.addEventListener('touchend', () => {
    joystick.active = false; joystick.dx = 0; joystick.dy = 0;
    stickNub.style.transform = `translate(0,0)`;
});
document.getElementById('fire-zone').addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

// --- LOGIC ---
function shoot() {
    if(player.dead) return;
    const angle = (isMobile && (joystick.dx||joystick.dy)) ? Math.atan2(joystick.dy, joystick.dx) : Math.atan2(mouse.y - player.y, mouse.x - player.x);
    bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*15, vy: Math.sin(angle)*15, color: skins[currentSkin].bullet });
    playSound('shoot');
}

function summonBoss() {
    if (bossActive) return;
    bossActive = true;
    warningText.style.display = 'block';
    playSound('boss_alarm');
    
    // Clear small enemies
    enemies.forEach(e => createExplosion(e.x, e.y, e.color, 5));
    enemies = []; 

    setTimeout(() => {
        warningText.style.display = 'none';
        enemies.push({
            x: width/2, y: -150, r: 80, hp: 300, maxHp: 300,
            type: 'boss', color: '#ff0000', speed: 2, angle: 0, reload: 0
        });
    }, 2000);
}

function spawnEnemy() {
    if(bossActive) return;

    // AUTO SPAWN BOSS AT 50 POINTS
    if(score >= 50 && !bossActive) {
        summonBoss();
        return;
    }

    // Spawn Normal Enemies
    const typeRoll = Math.random();
    let type = 'chaser', r = 15, hp = 1, color = '#ff0055', speed = 2 + Math.random();
    if(typeRoll > 0.7) { type = 'shooter'; color = '#00ff00'; speed = 1.5; }
    else if(typeRoll > 0.9) { type = 'tank'; r = 25; hp = 5; color = '#5555ff'; speed = 1; }

    let ex, ey;
    if(Math.random() < 0.5) {
        ex = Math.random() < 0.5 ? -50 : width+50; ey = Math.random()*height;
    } else {
        ex = Math.random()*width; ey = Math.random() < 0.5 ? -50 : height+50;
    }
    enemies.push({ x: ex, y: ey, r, hp, maxHp: hp, type, color, speed, angle: 0, reload: 0 });
}

function createExplosion(x, y, color, count) {
    for(let i=0; i<count; i++) particles.push({ x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1.0, color });
}

function update() {
    if(player.dead) return;
    frameCount++;

    // Move Player
    const spd = skins[currentSkin].speed;
    if(isMobile) { player.x += joystick.dx * spd; player.y += joystick.dy * spd; }
    else {
        if(keys['KeyW']) player.y -= spd; if(keys['KeyS']) player.y += spd;
        if(keys['KeyA']) player.x -= spd; if(keys['KeyD']) player.x += spd;
    }
    player.x = Math.max(15, Math.min(width-15, player.x));
    player.y = Math.max(15, Math.min(height-15, player.y));

    // Bullets
    bullets.forEach(b => { b.x += b.vx; b.y += b.vy; });
    bullets = bullets.filter(b => b.x > 0 && b.x < width && b.y > 0 && b.y < height);
    
    enemyBullets.forEach(b => { b.x += b.vx; b.y += b.vy; if(Math.hypot(b.x-player.x, b.y-player.y) < player.r) gameOver(); });
    enemyBullets = enemyBullets.filter(b => b.x > 0 && b.x < width && b.y > 0 && b.y < height);

    if(frameCount % 60 === 0) spawnEnemy();

    // Enemies
    for(let i=enemies.length-1; i>=0; i--) {
        let e = enemies[i];
        
        // Boss Logic
        if(e.type === 'boss') {
            e.y = Math.min(150, e.y + e.speed); // Move down
            e.angle += 0.02;
            e.reload++;
            if(e.reload > 40) { // Fast fire
                for(let k=0; k<12; k++) {
                    const ba = e.angle + (Math.PI*2/12)*k;
                    enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(ba)*5, vy: Math.sin(ba)*5 });
                }
                e.reload = 0;
            }
        } else {
            // Normal Logic
            const angle = Math.atan2(player.y - e.y, player.x - e.x);
            const dist = Math.hypot(player.x - e.x, player.y - e.y);
            if(e.type !== 'shooter' || dist > 200) { e.x += Math.cos(angle)*e.speed; e.y += Math.sin(angle)*e.speed; }
            if(e.type === 'shooter') {
                e.reload++;
                if(e.reload > 100) { enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(angle)*6, vy: Math.sin(angle)*6 }); e.reload = 0; }
            }
        }

        // Collision Bullet vs Enemy
        for(let j=bullets.length-1; j>=0; j--) {
            let b = bullets[j];
            if(Math.hypot(b.x - e.x, b.y - e.y) < e.r + 10) {
                createExplosion(b.x, b.y, skins[currentSkin].bullet, 2);
                bullets.splice(j, 1);
                e.hp--;
                if(e.hp <= 0) {
                    createExplosion(e.x, e.y, e.color, 15);
                    if(e.type === 'boss') { 
                        score += 1000; bossActive = false; 
                        createExplosion(e.x, e.y, 'gold', 50); 
                        alert("BOSS DEFEATED! YOU WIN!");
                    } else score += 10;
                    enemies.splice(i, 1);
                    uiScore.innerText = "SCORE: " + score;
                }
                break;
            }
        }
        if(enemies[i] && Math.hypot(player.x - enemies[i].x, player.y - enemies[i].y) < player.r + enemies[i].r) gameOver();
    }

    // Particles
    particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.05; });
    particles = particles.filter(p => p.life > 0);
}

function gameOver() {
    player.dead = true;
    createExplosion(player.x, player.y, skins[currentSkin].color, 50);
    setTimeout(() => { alert("GAME OVER! Score: " + score); startScreen.style.display = 'flex'; isPlaying = false; }, 100);
}

function draw() {
    ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, width, height);
    
    // Grid
    ctx.strokeStyle = '#001133'; ctx.lineWidth = 1; ctx.beginPath();
    for(let x=0; x<width; x+=50) { ctx.moveTo(x,0); ctx.lineTo(x,height); }
    for(let y=0; y<height; y+=50) { ctx.moveTo(0,y); ctx.lineTo(width,y); }
    ctx.stroke();

    if(player.dead) return;

    // Player
    ctx.save(); ctx.translate(player.x, player.y);
    const rot = (isMobile && (joystick.dx||joystick.dy)) ? Math.atan2(joystick.dy, joystick.dx) : Math.atan2(mouse.y-player.y, mouse.x-player.x);
    ctx.rotate(rot);
    ctx.fillStyle = skins[currentSkin].body; ctx.strokeStyle = skins[currentSkin].color; ctx.lineWidth = 2;
    ctx.shadowBlur = 10; ctx.shadowColor = skins[currentSkin].color;
    ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,15); ctx.lineTo(-5,0); ctx.lineTo(-15,-15); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.restore();

    // Projectiles
    bullets.forEach(b => { ctx.fillStyle = b.color; ctx.shadowColor = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
    enemyBullets.forEach(b => { ctx.fillStyle = '#fff'; ctx.shadowColor = 'red'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });

    // Enemies
    enemies.forEach(e => {
        ctx.save(); ctx.translate(e.x, e.y);
        ctx.strokeStyle = e.color; ctx.lineWidth = 2; ctx.shadowColor = e.color;
        
        if(e.type === 'boss') {
            ctx.rotate(e.angle);
            ctx.beginPath(); ctx.arc(0,0, e.r, 0, Math.PI*2); ctx.stroke(); // Outer ring
            ctx.beginPath(); ctx.moveTo(0, -e.r); ctx.lineTo(0, e.r); ctx.moveTo(-e.r, 0); ctx.lineTo(e.r, 0); ctx.stroke(); // Cross
            // Boss HP Bar
            ctx.restore(); // Restore context to draw HP bar non-rotated
            ctx.fillStyle = 'red'; ctx.fillRect(e.x - 50, e.y - 100, 100, 10);
            ctx.fillStyle = '#0f0'; ctx.fillRect(e.x - 50, e.y - 100, 100 * (e.hp/e.maxHp), 10);
        } else {
            if(e.type === 'shooter') { 
                ctx.beginPath(); for(let k=0; k<6; k++) ctx.lineTo(20*Math.cos(k*Math.PI/3), 20*Math.sin(k*Math.PI/3)); ctx.closePath(); ctx.stroke();
            } else if(e.type === 'tank') ctx.strokeRect(-e.r, -e.r, e.r*2, e.r*2);
            else { ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.closePath(); ctx.stroke(); }
            ctx.restore();
        }
    });

    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); ctx.globalAlpha = 1; });
}

function loop() { if(isPlaying) { update(); draw(); requestAnimationFrame(loop); } }
</script>
</body>
</html>
