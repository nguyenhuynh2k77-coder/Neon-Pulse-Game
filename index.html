<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pulse V11.1: Fixed</title>
    <style>
        body { margin: 0; padding: 0; background-color: #050510; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 15px; box-sizing: border-box; }
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .score-box { font-size: 20px; font-weight: bold; text-shadow: 0 0 10px cyan; }
        .wave-box { font-size: 24px; color: yellow; font-weight: bold; }
        
        .hp-wrapper { display: flex; flex-direction: column; gap: 5px; }
        .hp-container { width: 200px; height: 15px; background: #333; border: 2px solid #555; position: relative; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff5500); transition: width 0.2s; }
        #hp-text { position: absolute; top: -2px; left: 0; width: 100%; text-align: center; font-size: 12px; text-shadow: 1px 1px 1px black; }
        
        /* Shield Bar */
        #shield-container { width: 200px; height: 8px; background: #111; border: 1px solid #333; position: relative; display: none; }
        #shield-bar { width: 100%; height: 100%; background: #00ffff; box-shadow: 0 0 10px #00ffff; transition: width 0.2s; }
        
        .level-text { font-size: 14px; color: #00ffff; font-weight: bold; }

        #upgrade-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 200; }
        .card { width: 120px; height: 170px; background: rgba(0, 40, 60, 0.9); border: 2px solid cyan; border-radius: 8px; margin: 10px; padding: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .card:active { transform: scale(0.95); background: cyan; color: black; }

        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: auto; z-index: 100; }
        .skin-btn { width: 80px; height: 80px; border: 2px solid #555; border-radius: 10px; margin: 0 10px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.05); transition: 0.2s; }
        .skin-btn.selected { border-color: white; box-shadow: 0 0 20px white; background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .btn { padding: 15px 50px; margin-top: 30px; border: 2px solid cyan; color: cyan; background: transparent; font-size: 24px; cursor: pointer; font-weight: bold; transition: 0.2s; }

        #notify { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 40px; font-weight: bold; text-shadow: 0 0 20px white; display: none; animation: fadeUp 1.5s forwards; }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(20px); } 20% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        .control-zone { position: absolute; bottom: 30px; width: 120px; height: 120px; border-radius: 50%; pointer-events: auto; display: none; border: 2px solid rgba(255,255,255,0.1); }
        #stick-zone { left: 20px; } #fire-zone { right: 20px; background: rgba(255,0,0,0.1); }
        #stick-nub { width: 50px; height: 50px; background: rgba(0,255,255,0.5); border-radius: 50%; position: relative; top: 35px; left: 35px; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
    <div class="hud-top">
        <div>
            <div class="score-box" id="score-text">SCORE: 0</div>
            <div class="hp-wrapper">
                <div class="hp-container"><div id="hp-bar"></div><div id="hp-text">100/100</div></div>
                <div id="shield-container"><div id="shield-bar"></div></div>
            </div>
            <div class="level-text" id="level-text">SHIP LVL: 1</div>
        </div>
        <div class="wave-box" id="wave-text">WAVE 1</div>
    </div>
    <div id="notify"></div>
    <div id="stick-zone" class="control-zone"><div id="stick-nub"></div></div>
    <div id="fire-zone" class="control-zone"></div>
</div>

<div id="start-screen">
    <h1 style="color:cyan; font-size:40px; margin-bottom:10px;">NEON PULSE V11.1</h1>
    <p style="color:#ccc; margin-bottom:5px;">Lvl 5: Spikes | Lvl 10: Speed</p>
    <p style="color:#ccc; margin-bottom:20px;">Lvl 15: Energy Shield</p>
    <div style="display:flex;">
        <div class="skin-btn selected" onclick="selectSkin(0)">
            <div style="font-size:30px; color:#00ffff">üöÄ</div>
            <div style="font-size:12px; color:#00ffff; font-weight:bold">CYAN</div>
            <div style="font-size:10px; color:#aaa">DMG: 3</div>
        </div>
        <div class="skin-btn" onclick="selectSkin(1)">
            <div style="font-size:30px; color:#ff0055">üõ°Ô∏è</div>
            <div style="font-size:12px; color:#ff0055; font-weight:bold">RED</div>
            <div style="font-size:10px; color:#aaa">DMG: 8</div>
        </div>
        <div class="skin-btn" onclick="selectSkin(2)">
            <div style="font-size:30px; color:#ffff00">‚ö°</div>
            <div style="font-size:12px; color:#ffff00; font-weight:bold">GOLD</div>
            <div style="font-size:10px; color:#aaa">DMG: 1</div>
        </div>
    </div>
    <button class="btn" onclick="startGame()">START</button>
</div>

<div id="upgrade-modal">
    <h2>LEVEL UP!</h2>
    <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center;" id="cards-box"></div>
</div>

<div id="game-over-screen" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:100;pointer-events:auto;">
    <h1 style="color:red">MISSION FAILED</h1>
    <p id="final-score" style="color:white;font-size:24px;">Score: 0</p>
    <button class="btn" onclick="location.reload()">RETRY</button>
</div>

<script>
const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d',{alpha:false});
const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
let width, height;

// Core Stats
let isPlaying=false, isPaused=false, score=0, wave=1, frameCount=0;
let enemiesToSpawn=0, waveState='waiting', spawnTimer=0, waveTransitionTimer=0;

// Skins
let currentSkinIndex=0;
const skins=[
    {name:'Cyan', color:'#00ffff', body:'#003333', dmg:3, fireRate:25}, 
    {name:'Red',  color:'#ff0055', body:'#330011', dmg:8, fireRate:50},
    {name:'Gold', color:'#ffff00', body:'#333300', dmg:1, fireRate:18} 
];
function selectSkin(idx){ currentSkinIndex=idx; document.querySelectorAll('.skin-btn').forEach((b,i)=>b.classList.toggle('selected',i===idx)); }

// --- FIXED ORDER: PLAYER DEFINED BEFORE RESIZE ---
const player={
    x:0,y:0,r:15,hp:100,maxHp:100,dead:false,
    damage:1,fireRate:20,lastShot:0,shotCount:1,rearShot:false,
    bulletSize: 1,
    invulnTimer:0, level:1,
    shieldMax: 3, shieldCur: 0, shieldRegenTimer: 0
};

// NOW IT'S SAFE TO CALL RESIZE
function resize(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; if(!isPlaying){player.x=width/2;player.y=height/2;} }
window.addEventListener('resize',resize); resize();

if(isMobile){ document.getElementById('stick-zone').style.display='block'; document.getElementById('fire-zone').style.display='block'; }

// Entities
let bullets=[], enemyBullets=[], enemies=[], drops=[], floatingTexts=[];

// Upgrades
const upgradePool=[
    {id:'multishot',name:'ƒê·∫°n K√©p',icon:'üî´',desc:'+1 Tia ƒê·∫°n'},
    {id:'damage',name:'S√°t Th∆∞∆°ng',icon:'üí•',desc:'+1 Damage'},
    {id:'firerate',name:'T·ªëc B·∫Øn',icon:'‚ö°',desc:'B·∫Øn nhanh h∆°n'},
    {id:'giant',name:'ƒê·∫°n To',icon:'üí£',desc:'ƒê·∫°n to g·∫•p ƒë√¥i'},
    {id:'maxhp',name:'M√°u Tr√¢u',icon:'‚ù§Ô∏è',desc:'+20 Max HP'},
    {id:'rearshot',name:'B·∫Øn L∆∞ng',icon:'üîô',desc:'B·∫Øn ph√≠a sau'},
    {id:'heal',name:'H·ªìi Ph·ª•c',icon:'ü©π',desc:'H·ªìi 50 HP'}
];

// Audio
const AudioContext=window.AudioContext||window.webkitAudioContext; let actx;
function playSound(t){
    if(!actx)return; const o=actx.createOscillator(); const g=actx.createGain();
    o.connect(g); g.connect(actx.destination); const n=actx.currentTime;
    if(t==='shoot'){
        o.frequency.setValueAtTime(skins[currentSkinIndex].color==='#ff0055'?150:400,n);
        o.frequency.exponentialRampToValueAtTime(100,n+0.1);
        g.gain.setValueAtTime(0.05,n); g.gain.linearRampToValueAtTime(0,n+0.1);
        o.start(n); o.stop(n+0.1);
    } else if(t==='shield_break'){
        o.type='square'; o.frequency.setValueAtTime(150,n); o.frequency.linearRampToValueAtTime(50,n+0.3);
        g.gain.setValueAtTime(0.3,n); g.gain.linearRampToValueAtTime(0,n+0.3);
        o.start(n); o.stop(n+0.3);
    } else if(t==='shield_regen'){
        o.type='sine'; o.frequency.setValueAtTime(400,n); o.frequency.linearRampToValueAtTime(800,n+0.5);
        g.gain.setValueAtTime(0.3,n); g.gain.linearRampToValueAtTime(0,n+0.5);
        o.start(n); o.stop(n+0.5);
    } else if(t==='boom'){ 
        o.type='lowpass'; o.frequency.setValueAtTime(100,n); o.frequency.linearRampToValueAtTime(10,n+0.5);
        g.gain.setValueAtTime(0.8,n); g.gain.linearRampToValueAtTime(0,n+0.8);
        o.start(n); o.stop(n+0.8);
    }
}

function startGame(){
    document.getElementById('start-screen').style.display='none';
    const s=skins[currentSkinIndex];
    isPlaying=true; isPaused=false; score=0; wave=1;
    player.hp=100; player.maxHp=100; player.dead=false;
    player.damage=s.dmg; player.fireRate=s.fireRate; player.shotCount=1; player.rearShot=false;
    player.bulletSize=1; 
    player.x=width/2; player.y=height/2; player.level=1;
    player.shieldCur=0; 
    
    bullets=[]; enemies=[]; enemyBullets=[]; drops=[]; floatingTexts=[];
    updateUI(); actx=new AudioContext(); actx.resume();
    startWave(); requestAnimationFrame(loop);
}

function startWave(){
    waveState='spawning'; document.getElementById('wave-text').innerText="WAVE "+wave;
    showNotify("WAVE "+wave);
    waveTransitionTimer = 0;
    if(wave%10===0){enemiesToSpawn=1;spawnBoss('mega');}
    else if(wave%5===0){enemiesToSpawn=1;spawnBoss('mini');}
    else {enemiesToSpawn=4+Math.floor(wave*1.2);}
}

function spawnBoss(type){
    waveState='boss';
    let hp = (type==='mega') ? 300 + wave*30 : 100 + wave*15; 
    enemies.push({
        x:width/2, y:-100, r:type==='mega'?70:40, hp:hp, maxHp:hp, type:'boss_'+type,
        color:type==='mega'?'#ff0000':'#ffaa00', speed:type==='mega'?1:2, angle:0, reload:0
    });
    enemiesToSpawn = 0;
    showNotify(type==='mega'?"MEGA BOSS":"MINI BOSS");
}

function spawnNormal(){
    if(enemiesToSpawn<=0){waveState='fighting';return;}
    let type='chaser', hp=2+Math.floor(wave/5), spd=2+Math.random(), r=15, col='#ff0055';
    if(wave>=2 && Math.random()>0.7){type='shooter';col='#00ff00';spd=1.5;hp=3;}
    if(wave>=4 && Math.random()>0.9){type='tank';r=25;hp=8;col='#5555ff';spd=1;}
    let hpMultiplier = 1 + (wave * 0.1); hp = Math.floor(hp * hpMultiplier);
    let ex=Math.random()*width, ey=Math.random()*height;
    if(Math.random()<0.5)ex=(ex<width/2)?-50:width+50; else ey=(ey<height/2)?-50:height+50;
    enemies.push({x:ex, y:ey, r, hp, maxHp:hp, type, color:col, speed:spd, angle:0, reload:0});
    enemiesToSpawn--;
}

function triggerUpgrade(){
    isPaused=true; 
    const modal=document.getElementById('upgrade-modal'); const box=document.getElementById('cards-box');
    modal.style.display='flex'; box.innerHTML='';
    let choices=[]; while(choices.length<3){
        let item=upgradePool[Math.floor(Math.random()*upgradePool.length)];
        if(item.id === 'multishot' && player.shotCount >= 5) continue;
        if(!choices.includes(item))choices.push(item);
    }
    while(choices.length<3) choices.push(upgradePool[1]);
    choices.forEach(item=>{
        let c=document.createElement('div'); c.className='card';
        c.innerHTML=`<div style="font-size:35px">${item.icon}</div><div style="font-weight:bold">${item.name}</div><div style="font-size:11px;color:#ccc">${item.desc}</div>`;
        c.onclick=()=>applyUpgrade(item.id); box.appendChild(c);
    });
}

function applyUpgrade(id){
    player.level++;
    if(id==='multishot')player.shotCount++;
    if(id==='damage')player.damage++;
    if(id==='firerate')player.fireRate=Math.max(12, player.fireRate-2);
    if(id==='maxhp'){player.maxHp+=20;player.hp=player.maxHp;}
    if(id==='rearshot')player.rearShot=true;
    if(id==='heal')player.hp=Math.min(player.maxHp,player.hp+50);
    if(id==='giant')player.bulletSize += 0.5;

    if(player.level === 15) { player.shieldCur = player.shieldMax; playSound('shield_regen'); }
    updateUI(); document.getElementById('upgrade-modal').style.display='none';
    isPaused=false;
}

const keys={}; const mouse={x:0,y:0,down:false}; const joy={active:false,dx:0,dy:0,sx:0,sy:0};
window.onkeydown=e=>keys[e.code]=true; window.onkeyup=e=>keys[e.code]=false;
window.onmousemove=e=>{mouse.x=e.clientX;mouse.y=e.clientY;}; window.onmousedown=()=>mouse.down=true; window.onmouseup=()=>mouse.down=false;
const stick=document.getElementById('stick-zone'); const nub=document.getElementById('stick-nub');
stick.ontouchstart=e=>{e.preventDefault();joy.active=true;joy.sx=e.touches[0].clientX;joy.sy=e.touches[0].clientY;};
stick.ontouchmove=e=>{e.preventDefault();if(!joy.active)return; let dx=e.touches[0].clientX-joy.sx, dy=e.touches[0].clientY-joy.sy, d=Math.min(Math.hypot(dx,dy),35), a=Math.atan2(dy,dx); joy.dx=Math.cos(a); joy.dy=Math.sin(a); nub.style.transform=`translate(${joy.dx*d}px, ${joy.dy*d}px)`;};
stick.ontouchend=()=>{joy.active=false;joy.dx=0;joy.dy=0;nub.style.transform=`translate(0,0)`;};
document.getElementById('fire-zone').ontouchstart=e=>{e.preventDefault();mouse.down=true;}; document.getElementById('fire-zone').ontouchend=e=>{e.preventDefault();mouse.down=false;};

function update(){
    if(isPaused||player.dead)return;

    // SHIELD REGEN
    if(player.level >= 15 && player.shieldCur < player.shieldMax) {
        player.shieldRegenTimer++;
        if(player.shieldRegenTimer > 300) { 
            player.shieldCur = player.shieldMax; player.shieldRegenTimer = 0; playSound('shield_regen'); addText(player.x, player.y-40, "SHIELD READY", "#0ff");
        }
    }

    if(waveState==='spawning'){
        spawnTimer++; if(spawnTimer>40){ spawnNormal(); spawnTimer=0; }
        if(enemiesToSpawn===0 && enemies.length===0 && waveState!=='boss') waveState='fighting';
    }
    else if((waveState==='fighting'||waveState==='boss') && enemies.length===0 && enemiesToSpawn===0){
        waveTransitionTimer++;
        if(waveTransitionTimer > 120) { wave++; startWave(); }
    }

    let moveSpeed = (player.level >= 10) ? 7 : 5;
    if(isMobile){player.x+=joy.dx*moveSpeed;player.y+=joy.dy*moveSpeed;if(mouse.down)fire();}
    else{if(keys['KeyW'])player.y-=moveSpeed;if(keys['KeyS'])player.y+=moveSpeed;if(keys['KeyA'])player.x-=moveSpeed;if(keys['KeyD'])player.x+=moveSpeed;if(mouse.down||keys['Space'])fire();}
    player.x=Math.max(15,Math.min(width-15,player.x)); player.y=Math.max(15,Math.min(height-15,player.y));
    if(player.invulnTimer>0)player.invulnTimer--;

    bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy;}); bullets=bullets.filter(b=>b.x>0&&b.x<width&&b.y>0&&b.y<height);
    
    enemyBullets.forEach(b=>{
        b.x+=b.vx;b.y+=b.vy; 
        if(Math.hypot(b.x-player.x,b.y-player.y)<player.r+5) {
            if(player.shieldCur > 0) {
                player.shieldCur--; player.shieldRegenTimer = 0; playSound('shield_break'); addText(player.x, player.y-30, "BLOCKED", "#0ff");
            } else { takeDamage(10); }
            b.active = false;
        }
    });
    enemyBullets=enemyBullets.filter(b=>b.x>0&&b.x<width&&b.y>0&&b.y<height&&b.active!==false);

    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i], ang=Math.atan2(player.y-e.y,player.x-e.x);
        if(e.type.includes('boss')){
            e.y=Math.min(100,e.y+e.speed); e.reload++;
            let hasSpiral = (e.type==='boss_mega') || (wave > 10);
            if(hasSpiral && e.reload > 10) {
                e.angle += 0.15;
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle)*4, vy:Math.sin(e.angle)*4});
                if(e.type==='boss_mega') enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle+Math.PI)*4, vy:Math.sin(e.angle+Math.PI)*4});
                e.reload = 0;
            }
            if(!hasSpiral && e.reload > 50) {
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*6, vy:Math.sin(ang)*6}); e.reload = 0;
            }
        } else {
            if(e.type!=='shooter'||Math.hypot(player.x-e.x,player.y-e.y)>250){e.x+=Math.cos(ang)*e.speed;e.y+=Math.sin(ang)*e.speed;}
            if(e.type==='shooter'){e.reload++;if(e.reload>100){enemyBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*5,vy:Math.sin(ang)*5});e.reload=0;}}
        }
        
        for(let j=bullets.length-1;j>=0;j--){
            let br = 4 * player.bulletSize;
            if(Math.hypot(bullets[j].x-e.x,bullets[j].y-e.y) < e.r + br){
                bullets.splice(j,1); e.hp-=player.damage; e.x+=(Math.random()-0.5)*4; break;
            }
        }
        
        if(e.hp <= 0){
             enemies.splice(i,1); score+=(e.type.includes('boss')?500:10); playSound('hit');
             if(e.type==='boss_mini') spawnDrop(e.x, e.y, 'upgrade');
             else if(e.type==='boss_mega') { spawnDrop(e.x, e.y, 'upgrade'); spawnDrop(e.x+20, e.y, 'heal'); }
             else spawnDrop(e.x,e.y);
             continue;
        }

        if(enemies[i] && Math.hypot(player.x-enemies[i].x,player.y-enemies[i].y) < player.r+enemies[i].r){
            if(player.level >= 5) { enemies[i].hp -= 5; createParticles(enemies[i].x, enemies[i].y, 'white', 1); }
            takeDamage(20);
        }
    }

    for(let i=drops.length-1;i>=0;i--){
        let d=drops[i]; d.y+=Math.sin(frameCount/10)*0.5; d.life--;
        if(Math.hypot(player.x-d.x,player.y-d.y)<player.r+10){
            if(d.type==='upgrade')triggerUpgrade();
            else if(d.type==='heal'){player.hp=Math.min(player.maxHp,player.hp+30);addText(player.x,player.y,"+30 HP","#0f0");}
            else if(d.type==='nuke'){ enemyBullets=[]; enemies.forEach(e => { if(e.type.includes('boss')) { e.hp -= 50; addText(e.x, e.y, "-50", "white"); } else { e.hp -= 1000; } }); playSound('boom'); addText(player.x,player.y,"BOOM!!","white");}
            drops.splice(i,1);
        } else if(d.life<=0)drops.splice(i,1);
    }
    
    particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.1; });
    particles = particles.filter(p => p.life > 0);
    updateUI();
}

function createParticles(x, y, color, count) {
    for(let i=0; i<count; i++) particles.push({ x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 1.0, color });
}

function fire(){
    if(frameCount-(player.lastShot||0)<player.fireRate)return;
    player.lastShot=frameCount; playSound('shoot');
    const ang=(isMobile&&(joy.dx||joy.dy))?Math.atan2(joy.dy,joy.dx):Math.atan2(mouse.y-player.y,mouse.x-player.x);
    let startAng=ang-(player.shotCount-1)*0.08; 
    for(let i=0;i<player.shotCount;i++){let a=startAng+i*0.16;bullets.push({x:player.x,y:player.y,vx:Math.cos(a)*15,vy:Math.sin(a)*15});}
    if(player.rearShot)bullets.push({x:player.x,y:player.y,vx:Math.cos(ang+Math.PI)*15,vy:Math.sin(ang+Math.PI)*15});
}

function takeDamage(n){
    if(player.invulnTimer>0)return;
    if(player.shieldCur > 0) {
        player.shieldCur--; player.shieldRegenTimer = 0; playSound('shield_break'); addText(player.x, player.y-30, "SHIELD HIT", "#0ff"); player.invulnTimer=30; return;
    }
    player.hp-=n; player.invulnTimer=60; addText(player.x,player.y-30,"-"+n,"red");
    if(player.hp<=0){player.hp=0;isPlaying=false;document.getElementById('game-over-screen').style.display='flex';document.getElementById('final-score').innerText="Score: "+score;}
}

function spawnDrop(x,y,forceType){
    if(!forceType && Math.random()>0.4)return;
    let r=Math.random(),t='nuke',c='white';
    if(r < 0.20) { t='heal'; c='red'; }
    else if(r < 0.40) { t='upgrade'; c='cyan'; }
    else if(r < 0.42) { t='nuke'; c='white'; }
    else if(!forceType) return;
    if(forceType) { t=forceType; c=(t==='heal'?'red':'cyan'); }
    drops.push({x,y,type:t,color:c,life:600});
}

function addText(x,y,t,c){floatingTexts.push({x,y,t,c,life:50});}
function showNotify(t){const n=document.getElementById('notify');n.innerText=t;n.style.display='none';void n.offsetWidth;n.style.display='block';}
function updateUI(){
    document.getElementById('score-text').innerText="SCORE: "+score;
    document.getElementById('hp-bar').style.width=(player.hp/player.maxHp*100)+"%";
    document.getElementById('hp-text').innerText=Math.floor(player.hp)+"/"+player.maxHp;
    document.getElementById('level-text').innerText="SHIP LVL: " + player.level;
    const shieldEl = document.getElementById('shield-container');
    if(player.level >= 15) {
        shieldEl.style.display = 'block';
        document.getElementById('shield-bar').style.width = (player.shieldCur / player.shieldMax * 100) + "%";
    } else { shieldEl.style.display = 'none'; }
}

function draw(){
    ctx.fillStyle='#050510'; ctx.fillRect(0,0,width,height);
    ctx.strokeStyle='#001133'; ctx.lineWidth=1; ctx.beginPath();
    for(let x=0;x<width;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,height);}
    for(let y=0;y<height;y+=50){ctx.moveTo(0,y);ctx.lineTo(width,y);} ctx.stroke();

    drops.forEach(d=>{
        ctx.fillStyle=d.color; ctx.beginPath(); ctx.arc(d.x,d.y,10,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='black'; ctx.font='10px Arial'; ctx.textAlign='center';
        ctx.fillText(d.type==='upgrade'?'‚ö°':(d.type==='heal'?'‚ù§':'‚ò¢Ô∏è'), d.x,d.y+3);
    });

    if(!player.dead&&player.invulnTimer%4<2){
        ctx.save(); ctx.translate(player.x,player.y);
        let rot=(isMobile&&(joy.dx||joy.dy))?Math.atan2(joy.dy,joy.dx):Math.atan2(mouse.y-player.y,mouse.x-player.x);
        ctx.rotate(rot); const s=skins[currentSkinIndex];
        ctx.fillStyle=s.body; ctx.strokeStyle=s.color; ctx.lineWidth=2; ctx.shadowBlur=10; ctx.shadowColor=s.color;
        ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,15); ctx.lineTo(-5,0); ctx.lineTo(-15,-15); ctx.closePath(); ctx.fill(); ctx.stroke();
        
        if(player.level >= 5) { // Wings
            ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(-20, 25); ctx.lineTo(5, 10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-5, -10); ctx.lineTo(-20, -25); ctx.lineTo(5, -10); ctx.stroke();
        }
        if(player.level >= 10) { // Thrusters
            ctx.fillStyle = '#00ffff'; ctx.fillRect(-25, -5, 10, 3); ctx.fillRect(-25, 2, 10, 3);
        }
        if(player.level >= 15 && player.shieldCur > 0) { // Shield
            ctx.strokeStyle = `rgba(0, 255, 255, ${0.3 + (player.shieldCur/player.shieldMax)*0.7})`;
            ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0,0, 35, 0, Math.PI*2); ctx.stroke();
        }
        ctx.restore();
    }

    ctx.fillStyle='#ffff00'; 
    bullets.forEach(b=>{
        ctx.beginPath(); 
        let br = 4 * player.bulletSize; 
        ctx.arc(b.x,b.y, br, 0, Math.PI*2); 
        ctx.fill();
    });
    
    ctx.fillStyle='#fff'; enemyBullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();});

    enemies.forEach(e=>{
        ctx.save(); ctx.translate(e.x,e.y); ctx.strokeStyle=e.color; ctx.lineWidth=2; ctx.shadowColor=e.color;
        if(e.type.includes('boss')){
            ctx.rotate(e.angle); ctx.beginPath(); ctx.arc(0,0,e.r,0,Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-e.r,0); ctx.lineTo(e.r,0); ctx.moveTo(0,-e.r); ctx.lineTo(0,e.r); ctx.stroke();
        } else {
            if(e.type==='tank')ctx.strokeRect(-e.r,-e.r,e.r*2,e.r*2);
            else {ctx.beginPath();ctx.moveTo(15,0);ctx.lineTo(-10,10);ctx.lineTo(-10,-10);ctx.closePath();ctx.stroke();}
        }
        ctx.restore();
        if(e.hp<e.maxHp && e.hp>0){let bw=e.r*2;ctx.fillStyle='red';ctx.fillRect(e.x-bw/2,e.y-e.r-8,bw,3);ctx.fillStyle='#0f0';ctx.fillRect(e.x-bw/2,e.y-e.r-8,bw*(e.hp/e.maxHp),3);}
    });
    
    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); ctx.globalAlpha = 1; });
    floatingTexts.forEach(t=>{t.y-=1;t.life--;ctx.fillStyle=t.c;ctx.font='bold 16px Arial';ctx.fillText(t.t,t.x,t.y);}); floatingTexts=floatingTexts.filter(t=>t.life>0);
}

function loop(){ if(!isPaused){frameCount++;update();} if(isPlaying){draw();requestAnimationFrame(loop);} }
</script>
</body>
</html>
