<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pulse V5: Roguelike</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #050510;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between;
            padding: 15px; box-sizing: border-box;
        }
        
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .score-box { font-size: 20px; font-weight: bold; text-shadow: 0 0 10px cyan; }
        .wave-box { font-size: 24px; color: yellow; font-weight: bold; }
        
        /* HP Bar */
        .hp-wrapper { margin-top: 5px; }
        .hp-container {
            width: 200px; height: 15px;
            background: #333; border: 2px solid #555;
            position: relative;
        }
        #hp-bar {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff5500);
            transition: width 0.2s;
        }
        #hp-text {
            position: absolute; top: -2px; left: 0; width: 100%;
            text-align: center; font-size: 12px;
            text-shadow: 1px 1px 1px black;
        }

        /* Upgrade Modal (Roguelike Style) */
        #upgrade-modal {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* Flex when active */
            flex-direction: column;
            justify-content: center; align-items: center;
            pointer-events: auto; z-index: 200;
        }
        #upgrade-modal h2 { color: cyan; text-shadow: 0 0 20px cyan; margin-bottom: 30px; font-size: 30px; }
        .cards-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .card {
            width: 140px; height: 180px;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid cyan;
            border-radius: 10px;
            padding: 10px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        .card:hover { transform: scale(1.1); background: rgba(0, 40, 80, 1); border-color: white; }
        .card-icon { font-size: 40px; margin-bottom: 10px; }
        .card-title { font-weight: bold; color: #fff; margin-bottom: 5px; font-size: 16px; }
        .card-desc { font-size: 12px; color: #ccc; }

        /* Start & Game Over */
        #start-screen, #game-over-screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto; z-index: 100;
        }
        #game-over-screen { display: none; }
        .btn {
            padding: 15px 40px; margin-top: 20px;
            border: 2px solid cyan; color: cyan; background: transparent;
            font-size: 20px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 15px cyan;
        }
        
        /* Notification */
        #notify {
            position: absolute; top: 20%; width: 100%;
            text-align: center; font-size: 40px; font-weight: bold;
            text-shadow: 0 0 20px white; display: none;
            animation: fadeUp 1.5s forwards;
        }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(20px); } 20% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* Mobile Controls */
        .control-zone {
            position: absolute; bottom: 30px;
            width: 120px; height: 120px;
            border-radius: 50%; pointer-events: auto; display: none;
            border: 2px solid rgba(255,255,255,0.1);
        }
        #stick-zone { left: 20px; }
        #fire-zone { right: 20px; background: rgba(255,0,0,0.1); display: none; }
        #stick-nub {
            width: 50px; height: 50px; background: rgba(0,255,255,0.5);
            border-radius: 50%; position: relative; top: 35px; left: 35px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div>
                <div class="score-box" id="score-text">SCORE: 0</div>
                <div class="hp-wrapper">
                    <div class="hp-container">
                        <div id="hp-bar"></div>
                        <div id="hp-text">100/100</div>
                    </div>
                </div>
            </div>
            <div class="wave-box" id="wave-text">WAVE 1</div>
        </div>
        <div id="notify"></div>

        <div id="stick-zone" class="control-zone"><div id="stick-nub"></div></div>
        <div id="fire-zone" class="control-zone"></div>
    </div>

    <div id="upgrade-modal">
        <h2>CHOOSE UPGRADE</h2>
        <div class="cards-container" id="cards-box">
            </div>
    </div>

    <div id="start-screen">
        <h1 style="color:cyan; text-shadow:0 0 20px cyan; font-size:40px; text-align:center;">NEON ROGUE V5</h1>
        <p style="color:#ccc">Collect Blue Orbs to Upgrade!</p>
        <button class="btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="game-over-screen">
        <h1 style="color:red">GAME OVER</h1>
        <p id="final-score">Score: 0</p>
        <button class="btn" onclick="startGame()">RETRY</button>
    </div>

<script>
// --- CONFIG ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let width, height;

// --- STATE ---
let isPlaying = false;
let isPaused = false;
let score = 0;
let wave = 1;
let frameCount = 0;
let enemiesToSpawn = 0;
let spawnTimer = 0;
let waveState = 'waiting';

// --- PLAYER ---
const player = {
    x: 0, y: 0, r: 15,
    hp: 100, maxHp: 100,
    dead: false,
    damage: 1,      // S√°t th∆∞∆°ng m·ªói vi√™n ƒë·∫°n
    fireRate: 20,   // T·ªëc ƒë·ªô b·∫Øn (c√†ng nh·ªè c√†ng nhanh)
    shotCount: 1,   // S·ªë tia ƒë·∫°n (1, 2, 3...)
    rearShot: false,// B·∫Øn ph√≠a sau
    invulnTimer: 0
};

// --- ENTITIES ---
let bullets = [];
let enemyBullets = [];
let enemies = [];
let particles = [];
let drops = [];
let floatingTexts = [];

// --- UPGRADE POOL (Danh s√°ch n√¢ng c·∫•p) ---
const upgradePool = [
    { id: 'multishot', name: 'ƒê·∫°n K√©p', icon: 'üî´', desc: 'Th√™m 1 tia ƒë·∫°n b·∫Øn ra' },
    { id: 'damage',    name: 'TƒÉng Dame', icon: 'üí•', desc: 'S√°t th∆∞∆°ng +1 m·ªói vi√™n' },
    { id: 'firerate',  name: 'T·ªëc B·∫Øn', icon: '‚ö°', desc: 'B·∫Øn nhanh h∆°n 15%' },
    { id: 'maxhp',     name: 'M√°u Tr√¢u', icon: '‚ù§Ô∏è', desc: 'M√°u t·ªëi ƒëa +20 & H·ªìi ƒë·∫ßy' },
    { id: 'rearshot',  name: 'B·∫Øn L∆∞ng', icon: 'üîô', desc: 'B·∫Øn th√™m ƒë·∫°n ph√≠a sau' },
    { id: 'heal',      name: 'H·ªìi M√°u', icon: 'ü©π', desc: 'H·ªìi ph·ª•c 50% HP' }
];

// --- AUDIO ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx;
function playSound(type) {
    if (!actx) return;
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.connect(gain); gain.connect(actx.destination);
    const now = actx.currentTime;

    if (type === 'shoot') {
        osc.frequency.setValueAtTime(300 + (player.damage * 20), now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'hit') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'levelup') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now);
        osc.frequency.linearRampToValueAtTime(800, now + 0.5);
        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
        osc.start(now); osc.stop(now + 0.5);
    }
}

// --- INIT ---
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    if(!isPlaying) { player.x = width/2; player.y = height/2; }
}
window.addEventListener('resize', resize);
resize();
if (isMobile) {
    document.getElementById('stick-zone').style.display = 'block';
    document.getElementById('fire-zone').style.display = 'block';
}

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-over-screen').style.display = 'none';
    
    // Reset Stats
    isPlaying = true; isPaused = false;
    score = 0; wave = 1;
    player.hp = 100; player.maxHp = 100; player.dead = false;
    player.damage = 1; player.fireRate = 20; player.shotCount = 1; player.rearShot = false;
    player.x = width/2; player.y = height/2;
    
    bullets = []; enemies = []; enemyBullets = []; particles = []; drops = []; floatingTexts = [];
    
    updateUI();
    actx = new AudioContext(); actx.resume();
    startWave();
    requestAnimationFrame(loop);
}

// --- WAVE SYSTEM (NERFED) ---
function startWave() {
    waveState = 'spawning';
    document.getElementById('wave-text').innerText = "WAVE " + wave;
    showNotify("WAVE " + wave);

    if (wave % 10 === 0) {
        enemiesToSpawn = 1; spawnBoss('mega');
    } else if (wave % 5 === 0) {
        enemiesToSpawn = 1; spawnBoss('mini');
    } else {
        enemiesToSpawn = 5 + Math.floor(wave * 1.5);
    }
}

function spawnBoss(type) {
    waveState = 'boss';
    let boss;
    // NERFED HP HERE
    if (type === 'mega') {
        const bossHp = 600 + (wave * 50); // Reduced drastically
        boss = { x: width/2, y: -150, r: 70, hp: bossHp, maxHp: bossHp, type: 'boss_mega', color: '#ff0000', speed: 1, angle: 0, reload: 0 };
        showNotify("MEGA BOSS");
    } else {
        const bossHp = 200 + (wave * 30); // Reduced
        boss = { x: width/2, y: -100, r: 40, hp: bossHp, maxHp: bossHp, type: 'boss_mini', color: '#ffaa00', speed: 2, angle: 0, reload: 0 };
        showNotify("MINI BOSS");
    }
    enemies.push(boss);
    enemiesToSpawn = 0;
}

function spawnNormal() {
    if (enemiesToSpawn <= 0) { waveState = 'fighting'; return; }

    let type = 'chaser', hp = 2 + Math.floor(wave/5), spd = 2 + Math.random();
    let r = 15, color = '#ff0055';
    let roll = Math.random();

    if (wave >= 2 && roll > 0.7) { type = 'shooter'; color = '#00ff00'; spd = 1.5; hp = 3; }
    if (wave >= 4 && roll > 0.9) { type = 'tank'; r = 25; hp = 8 + Math.floor(wave/2); color = '#5555ff'; spd = 1; }

    let ex = Math.random()*width, ey = Math.random()*height;
    if(Math.random()<0.5) ex = (ex<width/2)? -50 : width+50; else ey = (ey<height/2)? -50 : height+50;

    enemies.push({ x: ex, y: ey, r, hp, maxHp: hp, type, color, speed: spd, angle: 0, reload: 0 });
    enemiesToSpawn--;
}

// --- UPGRADE SYSTEM ---
function triggerUpgrade() {
    isPaused = true;
    playSound('levelup');
    const modal = document.getElementById('upgrade-modal');
    const container = document.getElementById('cards-box');
    modal.style.display = 'flex';
    container.innerHTML = '';

    // Pick 3 random distinct upgrades
    let choices = [];
    while(choices.length < 3) {
        let item = upgradePool[Math.floor(Math.random() * upgradePool.length)];
        if(!choices.includes(item)) choices.push(item);
    }

    choices.forEach(item => {
        let card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="card-icon">${item.icon}</div><div class="card-title">${item.name}</div><div class="card-desc">${item.desc}</div>`;
        card.onclick = () => applyUpgrade(item.id);
        container.appendChild(card);
    });
}

function applyUpgrade(id) {
    if (id === 'multishot') player.shotCount++;
    if (id === 'damage') player.damage++;
    if (id === 'firerate') player.fireRate = Math.max(8, player.fireRate - 3); // Capped at 8
    if (id === 'maxhp') { player.maxHp += 20; player.hp = player.maxHp; }
    if (id === 'rearshot') player.rearShot = true;
    if (id === 'heal') player.hp = Math.min(player.hp + 50, player.maxHp);

    updateUI();
    document.getElementById('upgrade-modal').style.display = 'none';
    isPaused = false;
    requestAnimationFrame(loop);
}

// --- DROPS ---
function spawnDrop(x, y) {
    if (Math.random() > 0.25) return; 
    // Types: 'score' (white), 'heal' (red), 'upgrade' (cyan), 'speed' (yellow)
    let roll = Math.random();
    let type = 'score', color = 'white';
    
    if (roll < 0.1) { type = 'heal'; color = 'red'; }
    else if (roll < 0.2) { type = 'upgrade'; color = 'cyan'; } // Pause & Upgrade
    else if (roll < 0.3) { type = 'speed'; color = 'yellow'; } // Fire rate ONLY
    
    drops.push({ x, y, type, color, r: 10, life: 600 });
}

// --- INPUT & LOGIC ---
const keys = {};
const mouse = { x: 0, y: 0, down: false };
const joystick = { active: false, dx: 0, dy: 0, sx:0, sy:0 };

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;
window.onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY; };
window.onmousedown = () => mouse.down = true;
window.onmouseup = () => mouse.down = false;

const stick = document.getElementById('stick-zone');
const nub = document.getElementById('stick-nub');
stick.ontouchstart = e => { e.preventDefault(); joystick.active=true; joystick.sx=e.touches[0].clientX; joystick.sy=e.touches[0].clientY; };
stick.ontouchmove = e => {
    e.preventDefault(); if(!joystick.active)return;
    let dx = e.touches[0].clientX - joystick.sx, dy = e.touches[0].clientY - joystick.sy;
    let dist = Math.min(Math.hypot(dx,dy), 35);
    let ang = Math.atan2(dy,dx);
    joystick.dx = Math.cos(ang); joystick.dy = Math.sin(ang);
    nub.style.transform = `translate(${joystick.dx*dist}px, ${joystick.dy*dist}px)`;
};
stick.ontouchend = () => { joystick.active=false; joystick.dx=0; joystick.dy=0; nub.style.transform = `translate(0,0)`; };
document.getElementById('fire-zone').ontouchstart = e => { e.preventDefault(); mouse.down = true; };
document.getElementById('fire-zone').ontouchend = e => { e.preventDefault(); mouse.down = false; };

function update() {
    if (isPaused || player.dead) return;
    
    // Spawning
    if (waveState === 'spawning') {
        spawnTimer++;
        if (spawnTimer > 40) { spawnNormal(); spawnTimer = 0; }
    } else if (waveState === 'fighting' || waveState === 'boss') {
        if (enemies.length === 0 && enemiesToSpawn === 0) {
            wave++; setTimeout(startWave, 2000); waveState = 'waiting';
        }
    }

    // Player Move & Shoot
    if (isMobile) { player.x += joystick.dx*5; player.y += joystick.dy*5; if(mouse.down) fire(); }
    else {
        if(keys['KeyW']) player.y -= 5; if(keys['KeyS']) player.y += 5;
        if(keys['KeyA']) player.x -= 5; if(keys['KeyD']) player.x += 5;
        if(mouse.down || keys['Space']) fire();
    }
    player.x = Math.max(15, Math.min(width-15, player.x));
    player.y = Math.max(15, Math.min(height-15, player.y));
    if(player.invulnTimer > 0) player.invulnTimer--;

    // Bullets
    bullets.forEach(b => { b.x+=b.vx; b.y+=b.vy; });
    bullets = bullets.filter(b => b.x>0 && b.x<width && b.y>0 && b.y<height);

    enemyBullets.forEach(b => { 
        b.x+=b.vx; b.y+=b.vy; 
        if(Math.hypot(b.x-player.x, b.y-player.y) < player.r) takeDamage(10);
    });
    enemyBullets = enemyBullets.filter(b => b.x>0 && b.x<width && b.y>0 && b.y<height);

    // Enemies
    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        let ang = Math.atan2(player.y - e.y, player.x - e.x);
        
        // Move
        if (e.type.includes('boss')) {
            e.y = Math.min(100, e.y + e.speed);
            e.reload++;
            if (e.type === 'boss_mega' && e.reload > 8) { // Spiral
                e.angle += 0.1;
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle)*4, vy:Math.sin(e.angle)*4});
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(e.angle+Math.PI)*4, vy:Math.sin(e.angle+Math.PI)*4});
                e.reload = 0;
            } else if (e.type === 'boss_mini' && e.reload > 60) { // Aimed
                enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*6, vy:Math.sin(ang)*6});
                e.reload = 0;
            }
        } else {
            let dist = Math.hypot(player.x - e.x, player.y - e.y);
            if (e.type !== 'shooter' || dist > 250) { e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed; }
            if (e.type === 'shooter') {
                e.reload++;
                if (e.reload > 100) { enemyBullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5}); e.reload=0; }
            }
        }

        // Hit by player bullet
        for (let j = bullets.length - 1; j >= 0; j--) {
            if (Math.hypot(bullets[j].x - e.x, bullets[j].y - e.y) < e.r + 5) {
                bullets.splice(j, 1);
                e.hp -= player.damage;
                e.x += (Math.random()-0.5)*3; // Shake
                if (e.hp <= 0) {
                    enemies.splice(i, 1);
                    score += (e.type.includes('boss') ? 500 : 10);
                    spawnDrop(e.x, e.y);
                    playSound('hit');
                }
                break;
            }
        }
        if (enemies[i] && Math.hypot(player.x - enemies[i].x, player.y - enemies[i].y) < player.r + enemies[i].r) takeDamage(20);
    }

    // Drops
    for(let i=drops.length-1; i>=0; i--) {
        let d = drops[i]; d.y += Math.sin(frameCount/10)*0.5; d.life--;
        if(Math.hypot(player.x - d.x, player.y - d.y) < player.r + d.r) {
            if(d.type === 'upgrade') triggerUpgrade();
            else if(d.type === 'heal') { player.hp = Math.min(player.maxHp, player.hp + 30); addText(player.x, player.y, "+30 HP", "#0f0"); }
            else if(d.type === 'speed') { player.fireRate = Math.max(8, player.fireRate - 2); addText(player.x, player.y, "FIRE UP", "yellow"); } // Only Fire Rate
            else { score += 100; addText(player.x, player.y, "+100", "white"); }
            drops.splice(i, 1);
        } else if(d.life<=0) drops.splice(i,1);
    }
    updateUI();
}

function fire() {
    if (frameCount - (player.lastShot||0) < player.fireRate) return;
    player.lastShot = frameCount;
    playSound('shoot');
    const ang = (isMobile && (joystick.dx||joystick.dy)) ? Math.atan2(joystick.dy, joystick.dx) : Math.atan2(mouse.y - player.y, mouse.x - player.x);
    
    // Spread Logic
    let startAng = ang - (player.shotCount - 1) * 0.1;
    for(let i=0; i<player.shotCount; i++) {
        let a = startAng + i * 0.2;
        bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*15, vy:Math.sin(a)*15});
    }
    if(player.rearShot) bullets.push({x:player.x, y:player.y, vx:Math.cos(ang+Math.PI)*15, vy:Math.sin(ang+Math.PI)*15});
}

function takeDamage(amt) {
    if (player.invulnTimer > 0) return;
    player.hp -= amt; player.invulnTimer = 60;
    addText(player.x, player.y-30, "-"+amt, "red");
    if (player.hp <= 0) { player.hp=0; isPlaying=false; document.getElementById('game-over-screen').style.display='flex'; document.getElementById('final-score').innerText="Score: "+score; }
}

function addText(x, y, t, c) { floatingTexts.push({x, y, t, c, life: 50}); }
function showNotify(t) { 
    const n = document.getElementById('notify'); n.innerText = t; n.style.display='none'; 
    void n.offsetWidth; n.style.display='block'; 
}
function updateUI() {
    document.getElementById('score-text').innerText = "SCORE: " + score;
    document.getElementById('hp-bar').style.width = (player.hp / player.maxHp * 100) + "%";
    document.getElementById('hp-text').innerText = Math.floor(player.hp) + "/" + player.maxHp;
}

function draw() {
    ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, width, height);
    
    // Grid
    ctx.strokeStyle = '#001133'; ctx.lineWidth = 1; ctx.beginPath();
    for(let x=0; x<width; x+=50) { ctx.moveTo(x,0); ctx.lineTo(x,height); }
    for(let y=0; y<height; y+=50) { ctx.moveTo(0,y); ctx.lineTo(width,y); }
    ctx.stroke();

    // Drops
    drops.forEach(d => {
        ctx.fillStyle = d.color; ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black'; ctx.font='10px Arial'; ctx.textAlign='center'; 
        ctx.fillText(d.type==='upgrade'?'‚ö°':(d.type==='heal'?'‚ù§':(d.type==='speed'?'‚è©':'?')), d.x, d.y+3);
    });

    if (player.dead) return;

    // Player
    if (player.invulnTimer%4 < 2) {
        ctx.save(); ctx.translate(player.x, player.y);
        let rot = (isMobile && (joystick.dx||joystick.dy)) ? Math.atan2(joystick.dy, joystick.dx) : Math.atan2(mouse.y - player.y, mouse.x - player.x);
        ctx.rotate(rot);
        ctx.fillStyle='#003333'; ctx.strokeStyle='#00ffff'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,15); ctx.lineTo(-5,0); ctx.lineTo(-15,-15); ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.restore();
    }

    // Bullets
    ctx.fillStyle = '#ff0'; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
    ctx.fillStyle = '#fff'; enemyBullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });

    // Enemies & HP Bars
    enemies.forEach(e => {
        ctx.save(); ctx.translate(e.x, e.y);
        ctx.strokeStyle = e.color; ctx.lineWidth = 2; ctx.shadowColor = e.color;
        if (e.type.includes('boss')) {
            ctx.rotate(e.angle); ctx.beginPath(); ctx.arc(0,0, e.r, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-e.r,0); ctx.lineTo(e.r,0); ctx.moveTo(0,-e.r); ctx.lineTo(0,e.r); ctx.stroke();
        } else {
            if(e.type==='tank') ctx.strokeRect(-e.r,-e.r,e.r*2,e.r*2);
            else { ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.closePath(); ctx.stroke(); }
        }
        ctx.restore();

        // Draw Enemy HP Bar if damaged
        if (e.hp < e.maxHp) {
            let barW = e.r * 2;
            ctx.fillStyle = 'red'; ctx.fillRect(e.x - barW/2, e.y - e.r - 10, barW, 4);
            ctx.fillStyle = '#0f0'; ctx.fillRect(e.x - barW/2, e.y - e.r - 10, barW * (e.hp/e.maxHp), 4);
        }
    });

    // Floating Text
    floatingTexts.forEach(t => { 
        t.y-=1; t.life--; ctx.fillStyle = t.c; ctx.font = 'bold 16px Arial'; ctx.fillText(t.t, t.x, t.y); 
    });
    floatingTexts = floatingTexts.filter(t => t.life > 0);
}

function loop() {
    if(!isPaused) { frameCount++; update(); }
    if(isPlaying) { draw(); requestAnimationFrame(loop); }
}
</script>
</body>
</html>
